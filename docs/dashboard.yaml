  - type: sections
    title: Energy Bill
    path: energy-bill
    icon: mdi:lightning-bolt-circle
    sections:
      - type: grid
        cards:
          - type: heading
            heading_style: title
            heading: Forecast Energy Production
            grid_options:
              columns: 9
              rows: 1
            icon: mdi:solar-power
          - type: clock
            card_mod:
              style: |
                :host { }
                ha-card {
                  background: none;
                  border: none;
                  padding: 10px 0 0 0;
                  text-align: right;
                }
            grid_options:
              columns: 3
              rows: 1
        column_span: 2
      - type: grid
        cards:
          - type: custom:mushroom-entity-card
            entity: sensor.solcast_pv_forecast_forecast_this_hour
            grid_options:
              columns: 3
              rows: 1
            fill_container: true
            layout: horizontal
            name: This Hour
            icon: none
            icon_type: none
            card_mod:
              style: |
                ha-card {
                  background: none;
                  border: none;
                }
          - type: custom:mushroom-entity-card
            grid_options:
              columns: 3
              rows: 1
            fill_container: false
            layout: horizontal
            name: Next Hour
            icon: mdi:solar-power
            icon_type: none
            entity: sensor.solcast_pv_forecast_forecast_next_hour
            card_mod:
              style: |
                ha-card {
                  background: none;
                  border: none;
                }
          - type: custom:mushroom-entity-card
            fill_container: true
            layout: horizontal
            name: Remaining Today
            icon: none
            icon_type: none
            grid_options:
              columns: 3
              rows: 1
            entity: sensor.solcast_pv_forecast_forecast_remaining_today
            card_mod:
              style: |
                ha-card {
                  background: none;
                  border: none;
                }
          - type: custom:mushroom-entity-card
            grid_options:
              columns: 3
              rows: 1
            fill_container: true
            layout: horizontal
            name: Today
            icon: none
            icon_type: none
            entity: sensor.solcast_pv_forecast_forecast_today
            card_mod:
              style: |
                ha-card {
                  background: none;
                  border: none;
                }
          - type: custom:mushroom-entity-card
            entity: sensor.solcast_pv_forecast_forecast_tomorrow
            grid_options:
              columns: 6
              rows: 1
            fill_container: true
            name: Tomorrow
            icon: none
            icon_type: none
            card_mod:
              style: |
                ha-card {
                  background: none;
                  border: none;
                }
        column_span: 2
      - type: grid
        cards:
          - type: custom:power-flow-card-plus
            entities:
              battery:
                entity:
                  '0': b
                  '1': i
                  '2': 'n'
                  '3': a
                  '4': r
                  '5': 'y'
                  '6': _
                  '7': s
                  '8': e
                  '9': 'n'
                  '10': s
                  '11': o
                  '12': r
                  '13': .
                  '14': e
                  '15': s
                  '16': 'y'
                  '17': _
                  '18': s
                  '19': u
                  '20': 'n'
                  '21': h
                  '22': o
                  '23': m
                  '24': e
                  '25': _
                  '26': b
                  '27': a
                  '28': t
                  '29': t
                  '30': e
                  '31': r
                  '32': 'y'
                  '33': _
                  '34': a
                  '35': c
                  '36': t
                  '37': i
                  '38': v
                  '39': e
                  consumption: sensor.esy_sunhome_battery_export
                  production: sensor.esy_sunhome_battery_import
                state_of_charge: sensor.esy_sunhome_battery_state_of_charge
              grid:
                entity:
                  '0': b
                  '1': i
                  '2': 'n'
                  '3': a
                  '4': r
                  '5': 'y'
                  '6': _
                  '7': s
                  '8': e
                  '9': 'n'
                  '10': s
                  '11': o
                  '12': r
                  '13': .
                  '14': e
                  '15': s
                  '16': 'y'
                  '17': _
                  '18': s
                  '19': u
                  '20': 'n'
                  '21': h
                  '22': o
                  '23': m
                  '24': e
                  '25': _
                  '26': g
                  '27': r
                  '28': i
                  '29': d
                  '30': _
                  '31': a
                  '32': c
                  '33': t
                  '34': i
                  '35': v
                  '36': e
                  consumption: sensor.esy_sunhome_grid_import
                  production: sensor.esy_sunhome_grid_export
                secondary_info: {}
              solar:
                display_zero_state: true
                secondary_info: {}
                entity: sensor.esy_sunhome_pv_power
              home:
                secondary_info: {}
                use_metadata: false
                override_state: false
                subtract_individual: true
                entity: sensor.esy_sunhome_load_power
              fossil_fuel_percentage:
                secondary_info: {}
            clickable_entities: false
            display_zero_lines:
              mode: hide
              transparency: 50
              grey_color:
                - 189
                - 189
                - 189
            use_new_flow_rate_model: true
            w_decimals: 0
            kw_decimals: 1
            min_flow_rate: 0.75
            max_flow_rate: 6
            max_expected_power: 2000
            min_expected_power: 0.01
            watt_threshold: 1000
            transparency_zero_lines: 0
            sort_individual_devices: false
            dashboard_link: ''
          - type: energy-distribution
        column_span: 2
      - type: grid
        cards:
          - type: custom:apexcharts-card
            experimental:
              color_threshold: true
            graph_span: 24h
            span:
              start: minute
            header:
              show: true
              title: Amber Electricty Forecast
              show_states: false
              colorize_states: true
            series:
              - entity: sensor.home_general_forecast
                float_precision: 2
                color_threshold:
                  - value: 0
                    color: cyan
                  - value: 0.16
                    color: green
                  - value: 0.25
                    color: yellow
                  - value: 0.4
                    color: red
                name: price kwh
                data_generator: |
                  return entity.attributes.forecasts.map((entry) => {
                    return [new Date(entry.start_time), entry.per_kwh];
                  });
            yaxis:
              - min: 0
                max: ~0.5
                decimals: 2
                apex_config:
                  forceNiceScale: true
            apex_config:
              stroke:
                width: 2.5
              grid:
                show: true
                borderColor: '#333'
                strokeDashArray: 1
          - type: custom:apexcharts-card
            experimental:
              color_threshold: true
            graph_span: 24h
            span:
              start: minute
            header:
              show: true
              title: Amber Feed-In Forecast
              show_states: false
              colorize_states: true
            series:
              - entity: sensor.home_feed_in_forecast
                float_precision: 2
                color_threshold:
                  - value: 0
                    color: red
                  - value: 0.16
                    color: yellow
                  - value: 0.25
                    color: cyan
                  - value: 0.5
                    color: green
                name: price kwh
                data_generator: |
                  return entity.attributes.forecasts.map((entry) => {
                    return [new Date(entry.start_time), entry.per_kwh];
                  });
            yaxis:
              - min: ~0
                max: ~0.5
                decimals: 2
                apex_config:
                  forceNiceScale: true
            apex_config:
              stroke:
                width: 2.5
              grid:
                show: true
                borderColor: '#333'
                strokeDashArray: 1
        column_span: 2
      - type: grid
        cards:
          - type: energy-sankey
            grid_options:
              columns: 24
              rows: 4
        column_span: 2
      - type: grid
        cards:
          - type: custom:apexcharts-card
            layout_options:
              grid_columns: 24
            experimental:
              disable_config_validation: true
            graph_span: 24h
            span:
              end: day
              offset: +1h
            yaxis:
              - decimals: 2
                apex_config:
                  forceNiceScale: true
                  labels:
                    formatter: |
                      EVAL:function(value) {
                        if (value.toString().length > 6)
                          return '0.00';
                        return Math.abs(value).toFixed(2);
                      }
            apex_config:
              annotations:
                position: front
              chart:
                height: 400
              stroke:
                width: 2
              grid:
                show: false
              xaxis:
                lines:
                  show: false
                axisBorder:
                  show: false
              yaxis:
                axisBorder:
                  show: false
              legend:
                show: false
            all_series_config:
              extend_to: now
              float_precision: 2
            stacked: true
            series:
              - entity: sensor.half_hour_max_import
                type: column
                name: Import from Grid
                color: '#656567'
                show:
                  datalabels: false
                  extremas: false
                invert: true
                group_by:
                  func: max
                  duration: 30m
                transform: 'return x == 0.0 ? null : x;'
              - entity: sensor.half_hour_max_consumption
                type: column
                name: Consumption
                color: '#d67629'
                show:
                  datalabels: false
                  extremas: false
                invert: true
                group_by:
                  func: last
                  duration: 30m
                transform: 'return x == 0.0 ? null : x;'
              - entity: sensor.half_hour_max_production
                type: column
                name: Production
                color: '#6eb4dc'
                show:
                  datalabels: false
                  extremas: false
                invert: false
                group_by:
                  func: last
                  duration: 30m
                transform: 'return x == 0.0 ? null : x;'
              - entity: sensor.half_hour_max_export
                type: column
                name: Export to Grid
                color: '#656567'
                show:
                  datalabels: false
                  extremas: false
                invert: false
                group_by:
                  func: last
                  duration: 30m
                transform: 'return x == 0.0 ? null : x;'
            card_mod:
              style: |
                :host {
                  width: 100%
                }
                ha-card {
                  width: 100%;
                }
                .wrapper.with-header {
                  width: 100%;
                }
        column_span: 2
    header: {}
    cards: []
    badges:
      - type: custom:mushroom-template-badge
        content: '{{ ((25 * ((states(entity) | int)/100)) | float(0)) | round(1) }} kWh'
        color: |-
          {% set number = (states(entity) | int) %}
          {% if (number >= 70) %}
          green
          {% elif (number >= 40) %}
          yellow
          {% elif (number >= 30) %}
          orange
          {% else %}
          red
          {% endif %}
        label: Battery SoC - {{(states(entity) | int)}}%
        tap_action:
          action: navigate
          navigation_path: /config/devices/device/91b5a8d4f272ea50b568420b3e866baf
        entity: sensor.esy_sunhome_battery_state_of_charge
        icon: |-
          {% set number = (states(entity) | int) %}
          {% if (number >= 90) %}
          mdi:battery
          {% elif (number >= 80) %}
          mdi:battery-80
          {% elif (number >= 70) %}
          mdi:battery-70
          {% elif (number >= 60) %}
          mdi:battery-60
          {% elif (number >= 50) %}
          mdi:battery-50
          {% elif (number >= 40) %}
          mdi:battery-40
          {% elif (number >= 30) %}
          mdi:battery-30
          {% elif (number >= 20) %}
          mdi:battery-20
          {% elif (number >= 10) %}
          mdi:battery-10
          {% elif (number >= 0) %}
          mdi:battery-outline
          {% else %}
          mdi:battery
          {% endif %}
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: sensor.esy_sunhome_pv_power
        name: 'Production '
        color: accent
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: sensor.esy_sunhome_load_power
        name: Consumption
      - type: custom:mushroom-template-badge
        icon: mdi:currency-usd
        label: Daily Cost
        content: ${{ states.sensor.daily_cost.state | float | round(2) }}
        entity: sensor.daily_cost
        color: |-
          {% set rate=states(entity) | float %}
          {% if rate > 1 %}
          red
          {% elif rate < 0 %}
          green
          {% else %}
          yellow
          {% endif %}
        double_tap_action:
          action: url
          url_path: app://com.amberelectric.customerportal
        hold_action:
          action: url
          url_path: app://com.amberelectric.customerportal
        tap_action:
          action: more-info
      - type: custom:mushroom-template-badge
        icon: mdi:currency-usd
        label: Monthly Cost
        content: ${{ states.sensor.monthly_cost.state | float | round(2) }}
        color: |-
          {% set rate=states(entity) | float %}
          {% if rate > 20 %}
          red
          {% elif rate < 0 %}
          green
          {% else %}
          yellow
          {% endif %}
        entity: sensor.monthly_cost
        double_tap_action:
          action: url
          url_path: app://com.amberelectric.customerportal
        hold_action:
          action: url
          url_path: app://com.amberelectric.customerportal
      - type: custom:mushroom-template-badge
        content: >-
          {{ (states.sensor.current_charge.state  | float(0) * 100) | round(1)
          }}c / kWh
        entity: sensor.current_rate
        color: |-
          {% set rate=states(entity) %}
          {# [ negative, extremelyLow, veryLow, low, neutral, high, spike ] #}
          {% if rate == 'Negative' %}
          green
          {% elif rate == 'Extremely Low' %}
          green
          {% elif rate == 'Very Low' %}
          green
          {% elif rate == 'Low' %}
          yellow
          {% elif rate == 'Neutral' %}
          red
          {% elif rate == 'High' %}
          red
          {% elif rate == 'Spike' %}
          red
          {% else %}
          white
          {% endif %}
        label: 'Import - {{states.sensor.current_rate.state }} '
        double_tap_action:
          action: url
          url_path: app://com.amberelectric.customerportal
        hold_action:
          action: url
          url_path: app://com.amberelectric.customerportal
        icon: mdi:transmission-tower-import
      - type: custom:mushroom-template-badge
        content: >-
          {{ (states.number.current_export_charge.state | float(0) * 100) |
          round(1) }}c / kWh
        color: |-
          {% set rate=states(entity) %}
          {# [ negative, extremelyLow, veryLow, low, neutral, high, spike ] #}
          {% if rate == 'Negative' %}
          red
          {% elif rate == 'Extremely Low' %}
          red
          {% elif rate == 'Very Low' %}
          green
          {% elif rate == 'Low' %}
          yellow
          {% elif rate == 'Neutral' %}
          yellow
          {% elif rate == 'High' %}
          green
          {% elif rate == 'Spike' %}
          green
          {% else %}
          white
          {% endif %}
        label: 'Export - {{states.sensor.current_export_rate.state}} '
        double_tap_action:
          action: url
          url_path: app://com.amberelectric.customerportal
        hold_action:
          action: url
          url_path: app://com.amberelectric.customerportal
        entity: sensor.current_export_rate
        icon: mdi:transmission-tower-export
    max_columns: 2
    dense_section_placement: false